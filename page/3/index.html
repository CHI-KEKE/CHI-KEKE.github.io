<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>平屋慢生活 - Coding也是生活的溫暖調味</title><meta name="author" content="Allen"><meta name="copyright" content="Allen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta property="og:type" content="website">
<meta property="og:title" content="平屋慢生活">
<meta property="og:url" content="https://chi-keke.github.io/page/3/">
<meta property="og:site_name" content="平屋慢生活">
<meta property="og:locale">
<meta property="og:image" content="https://i.imgur.com/q4xr50n.png">
<meta property="article:author" content="Allen">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/q4xr50n.png"><link rel="shortcut icon" href="/img/kiwibird.png"><link rel="canonical" href="https://chi-keke.github.io/page/3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '平屋慢生活',
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2025-09-20 12:21:41'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.imgur.com/q4xr50n.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">66</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header" style="background-image: url('https://i.imgur.com/86eENHu.png')"><nav id="nav"><span id="blog-info"><a href="/" title="平屋慢生活"><span class="site-name">平屋慢生活</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">平屋慢生活</h1><div id="site_social_icons"><a class="social-icon" href="https://github.com/CHI-KEKE" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:chilly37647@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/28/NEW-EFCORE-TimeoutException-part1/" title="EF Core - TimeoutException (Part 1)"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - TimeoutException (Part 1)"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/28/NEW-EFCORE-TimeoutException-part1/" title="EF Core - TimeoutException (Part 1)">EF Core - TimeoutException (Part 1)</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-28T00:26:05.000Z" title="Created 2025-05-28 08:26:05">2025-05-28</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">


某天早上，監控系統跳出好幾個 TimeoutException，我們小組群組裡只聽到一句：「啊，應該是網路問題吧，再跑一次就好了。」
這句話讓我背脊一涼。
TimeoutException 並不是資料庫在耍脾氣，它是壓力太大在吶喊。這篇文章，要來好好梳理這些 “吶喊” 背後的真正原因。



🌊 查詢資料太多，撐爆記憶體

有時候你只是開個後台報表，卻默默查了幾十萬筆資料。久而久之，伺服器就跟泡麵一樣——泡過頭，膨脹爛掉。


1️⃣ 真的需要全部資料嗎？
商業情境：報表開發初期為求簡便，可能會習慣「全撈」資料來呈現，但實際使用者只會看最近的記錄。

1234var threeMonthsAgo = DateTime.UtcNow.AddMonths(-3);var recentOrders = await dbContext.Orders    .Where(o =&gt; o.CreatedDate &gt;= threeMonthsAgo)    .ToListAsync();




2️⃣ 使用投影（Select）只抓必要欄位
商業情境：畫面僅顯示使用者名稱與註冊時間 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/28/NEW-EFCORE-TimeoutException-part2/" title="EF Core - TimeoutException PART 2"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - TimeoutException PART 2"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/28/NEW-EFCORE-TimeoutException-part2/" title="EF Core - TimeoutException PART 2">EF Core - TimeoutException PART 2</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-28T00:26:05.000Z" title="Created 2025-05-28 08:26:05">2025-05-28</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">



本篇 ~ 繼續 ~ TimeoutException 可能發生的原因及改善方式，從 Lock、Isolation Level、Retry、連線池，到 Change Tracker 與批次處理


🌊 為什麼資料庫會「卡住」？—— 談 Lock

🔒 資料庫為什麼會 Lock？當兩個交易（Transaction）同時存取資料時，為了確保資料一致性，資料庫會自動幫我們上鎖。像是：

其他交易正在修改這筆資料（而還沒提交 Commit）
你要修改的資料已經被排他鎖定

這時候，後來的交易就只能等別人釋放鎖，不然就只能拋錯。等待超過 Command Timeout，就會拋出 TimeoutException 或 SqlException。



關鍵例外訊息可能會有哪些？1234567System.TimeoutExceptionMicrosoft.Data.SqlClient.SqlException常見訊息：Timeout expired. The timeout period elapsed prior to completion of the operation or th ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/27/NEW-EFCORE-Logging/" title="EF Core - Logging"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - Logging"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/27/NEW-EFCORE-Logging/" title="EF Core - Logging">EF Core - Logging</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-26T23:38:05.000Z" title="Created 2025-05-27 07:38:05">2025-05-27</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">



在平穩無波的資料操作背後，EF Core 為我們自動生成了大量 SQL 語法。這些語法就像資料的悄悄話，大部分時間默默運作，沒出錯就好。但一旦效能下滑、查詢遲緩，這些悄悄話就需要被「聽見」。
因此，我們需要打開 EF Core 的日誌紀錄機制，看看背後究竟在跑什麼樣的 SQL。
🌊 為什麼要紀錄 EF Core 自動產生的 SQL 命令?EF Core 是一套功能強大的 ORM 框架，幫助我們用物件導向的方式操作資料。但 ORM 所產生的 SQL 並非總是最有效率的選擇。
透過 Logging，我們可以：

檢查 EF Core 實際送出的 SQL 語法  
發現不必要的 JOIN 或 WHERE 條件  
優化查詢速度（例如加上索引、改用 View 或 Stored Procedure）

這對效能調教與除錯都非常有幫助。
🌊 調整 appsettings.json 的 LogLevel12345678910&#123;  &quot;Logging&quot;: &#123;    &quot;LogLevel&quot;: &#123;      &quot;Defa ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/25/NEW-EFCORE-Transaction-%E8%B7%A8/" title="EF Core - 交易的界線"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - 交易的界線"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/25/NEW-EFCORE-Transaction-%E8%B7%A8/" title="EF Core - 交易的界線">EF Core - 交易的界線</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-25T03:04:05.000Z" title="Created 2025-05-25 11:04:05">2025-05-25</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">
「啊…我有開 TransactionScopeAsyncFlowOption.Enabled 嗎？」「咦？這兩個 Context 是不是不同連線？」「等一下，我是不是跨資料庫了？那 MSDTC 呢？」
交易的邊界，就像洋流與領海，有時你以為你還在安全區，其實早已飄出防線。
這篇筆記，就是一趟從這場 Bug 航行而來的實驗紀錄 —— 我們用四種實際情境來測試 EF Core 的交易能力：

同資料庫、不同 DbContext
跨資料庫
共用連線 vs 不共用連線
TransactionScope vs BeginTransaction

如果你也曾在交易邊界迷航過，歡迎登船。



🧭 實驗開航前：DBContext 的布陣

為了這趟「交易航線實驗」，我們準備了三個 DbContext：

AdventureWorks2022：一個普通的 DbContext。
AdventureWorks2022V2：與 AdventureWorks2022 使用相同的資料庫，但是不同的 DbContext 實例。
NexCommerce_CouponContext：指向另一個資料庫。

123b ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/23/NEW-EFCORE-Dapper/" title="Dapper vs EF Core"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dapper vs EF Core"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/23/NEW-EFCORE-Dapper/" title="Dapper vs EF Core">Dapper vs EF Core</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-23T14:07:05.000Z" title="Created 2025-05-23 22:07:05">2025-05-23</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">




如果資料存取是場人生選擇，那 EF Core 就像「全包式旅行團」：行李、住宿、行程幫你安排好，你只要準時上車；而 Dapper 則像「背包客自由行」：想去哪、怎麼走、要不要迷路，全靠你自己。

在 .NET 的世界裡，EF Core 與 Dapper 是資料存取的兩大門派，一個幫你包辦大小事，一個讓你操控每一行 SQL。
你可能常常陷入這種掙扎：
「欸現在這隻微服務要查一堆訂單、明細、客戶資料，我要不要用 EF？還是會變龜速大怪獸？」「有三層關聯欸，用 Dapper 要手動 map 到哭出來，欄位一多手都斷了吧…」


🌊 ORM

在開發應用程式時，資料通常儲存在資料庫（Database）中，而程式則是用物件（Object）在操作資料。但是資料庫與程式是兩種世界

資料庫用的是「表格」（table）來存資料，C# 用的是「物件」和「類別」

這兩個東西的結構不同、語言不同、邏輯也不同。


👉 ORM（Object-Relational Mapping）本質是什麼？

它是一座橋梁，幫你自動把「資料表」轉成「物件」，也幫你把你操作的物件轉回資料表格式，這個過程就叫做  ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/20/NEW-EFCORE-Scoped/" title="EF Core - DbContext 生命週期"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - DbContext 生命週期"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/20/NEW-EFCORE-Scoped/" title="EF Core - DbContext 生命週期">EF Core - DbContext 生命週期</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-20T07:28:05.000Z" title="Created 2025-05-20 15:28:05">2025-05-20</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">




「這裡的風很大，請小心 DbContext 被吹出作用域。」

開發 ASP.NET Core 應用程式時，你一定碰過這段設定
1services.AddDbContext&lt;MyDbContext&gt;();
這一行註冊你的 DbContext，但你知道它的 生命週期（Lifetime）是什麼嗎？Scoped、Transient 差在哪？又該怎麼選擇？今天我們就來一趟資料庫生命週期的航行。
🌊 EF Core 的預設生命週期：ScopedEntity Framework contexts

By default, Entity Framework contexts are added to the service container using the    scoped lifetime because web app database operations are normally scoped to the client request.

簡單來說，EF Core 的 DbContext 預設會註冊成 Scoped，也就是，每個 HTTP Request 會 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/19/NEW-EFCORE-Transaction/" title="EF Core - Transaction"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - Transaction"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/19/NEW-EFCORE-Transaction/" title="EF Core - Transaction">EF Core - Transaction</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-19T14:07:05.000Z" title="Created 2025-05-19 22:07:05">2025-05-19</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">



🐧關於 Transaction在系統開發中，最可怕的狀況不是資料存不進去，而是「資料只成功了一半」。
你可能會覺得沒什麼——多一筆少一筆資料，好像影響不大。但實際上，這種「半成品」的狀態，才是造成系統錯誤與災難的根源。

使用者下單成功了，庫存卻沒扣 → 超賣
客戶付款完成，但系統沒記帳 → 客訴、查帳風暴
發票開出來了，卻沒連到訂單 → 財報對不起來

這些問題不是 bug，也不是 crash，而是資料邏輯不一致，讓系統表面正常、實際混亂。這時候，就需要一種「全部成功或全部失敗」的保護機制 —— 這就是 交易（Transaction） 的存在價值。
交易就像你畫圖時的一顆橡皮擦：如果中間畫錯了，可以整張擦掉重來，而不是留下殘破不堪的塗鴉。
Using Transactions


🌊 SaveChanges() 自動包成 Transaction在 EF Core 中，只要你呼叫 SaveChanges() 或 SaveChangesAsync()，它就會自動包一個隱含的交易（Implicit Transaction）。這代表：
1234567using (var cont ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/15/Dependency-Injection-4/" title="Dependency Injection - 生命週期"><img class="post-bg" src="https://i.imgur.com/xAbpKgd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dependency Injection - 生命週期"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/15/Dependency-Injection-4/" title="Dependency Injection - 生命週期">Dependency Injection - 生命週期</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-15T00:07:05.000Z" title="Created 2025-05-15 08:07:05">2025-05-15</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%B3%A8%E5%85%A5%E4%B9%8B%E6%A3%AE/">注入之森</a></span></div><div class="content">穿過茂密的樹影與輕柔的晨霧，你走進了一座靜謐的森林。
那裡沒有 bug，沒有 exception，只有陽光灑落的參天樹、木製窗框散出香氣的小屋
你打開門，進入了一間森林旅宿。櫃檯小姐微笑地遞給你一張房卡，你今晚的房間已經準備好了。
對旅宿而言，房間是 Singleton 生命週期的服務，從你入住前到離開後，它始終如一地在那裡 —— 只建一次，長存不變
你看著桌上放著一組乾淨的 Scoped 盥洗用品：牙刷、毛巾、小瓶洗髮精。它們會陪你走完這段住宿時光，使用多少、如何使用，全由你決定。但當你退房時，它們也會一起離開，下一位旅人會拿到全新的組合。
角落還放著衛生紙，柔軟、乾淨，隨時可以撕下一張來使用。你不會重複用它，也不會留著它，只會在需要的時候取一張。這，就是 Transient：臨時、即用即丟、毫無記憶的存在。
不同的服務有不同的生命週期，就像不同的物品有不同的使用方式 —— 如果錯把盥洗用品作為 Singleton 使用，那麼下一位旅客來到時，拿到的可能就是使用過得噁心牙刷。
設計生命週期的本質，不是為了節省資源，而是為了讓每一段旅程，都能乾淨、清晰、可控地發生。請進吧，旅人。我們即 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/15/Dependency-Injection-3/" title="Dependency Injection - 註冊、注入"><img class="post-bg" src="https://i.imgur.com/xAbpKgd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dependency Injection - 註冊、注入"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/15/Dependency-Injection-3/" title="Dependency Injection - 註冊、注入">Dependency Injection - 註冊、注入</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-15T00:07:05.000Z" title="Created 2025-05-15 08:07:05">2025-05-15</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%B3%A8%E5%85%A5%E4%B9%8B%E6%A3%AE/">注入之森</a></span></div><div class="content">
有一天，我夢見我死了。
地獄門口，閻羅王拿出一本厚厚的註冊清單，一邊唸：「根據你的 ServiceCollection，這輩子你註冊了以下幾項依賴…」
12345678IConfidenceService          → FakeItTillYouMakeItServiceILoveService                → UnhealthyAttachmentServiceILogger&lt;YourLife&gt;           → Mom&#x27;sConstantNaggingICareerPlanner              → JustFollowWhatEveryoneElseDidServiceISelfWorthEvaluator         → DependsOnLikesAndRetweetsServiceIPurposeOfLifeResolver      → null

我試圖抗議：「等等！我沒有註冊這些啊！」閻羅王翻了翻後台的 StackTrace，淡淡地說：「人走著走著、就註冊成這樣了。」
「每一次討好別人，你就呼叫了  ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/13/Dependency-Injection-2/" title="Dependency Injection - 靜態與依賴"><img class="post-bg" src="https://i.imgur.com/xAbpKgd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dependency Injection - 靜態與依賴"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/13/Dependency-Injection-2/" title="Dependency Injection - 靜態與依賴">Dependency Injection - 靜態與依賴</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-13T14:07:05.000Z" title="Created 2025-05-13 22:07:05">2025-05-13</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%B3%A8%E5%85%A5%E4%B9%8B%E6%A3%AE/">注入之森</a></span></div><div class="content">


今天到全聯購買了一個體重計，標籤上面寫著 static，售價 500 元。我心想：「不錯，夠便宜，看起來也夠簡單，剛好放在家門口踩一下就知道我今天有沒有胖。」回家之後，我站上去，顯示 66.6kg。
我不滿意。
我開始對著體重計自言自語：
「欸欸，我昨天吃太鹹啦，應該有水腫，不能算胖吧？」「還有，最近氣壓很低，影響感測精度你懂嗎？」「而且我最近壓力比較大可能會影響賀爾蒙，體脂肪是不是也該調整一下？」
我認真思考了一下，決定用 Dependency Injection 改造這台體重機。我開始設計以下注入內容：

IDietHistoryAnalyzer：幫我判斷昨天晚餐的影響，還會取得目前的健康最新趨勢分析
IPressureSensingService：計算壓力變動
IWeatherSensorProvider：拉取最新的氣壓與濕度資料

還打算加個 IMoodService，畢竟心情不好看起來也會比較腫，我把所有服務都準備好了，轉頭對體重機說：
「接下來，你要根據這些注入的資料來動態回傳我的理想體重。」
體重機沉默了幾秒，然後…… 它還是顯示了 66.6kg。不只沒變，它還開始 ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/2/#content-inner"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/#content-inner">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/#content-inner">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/#content-inner">7</a><a class="extend next" rel="next" href="/page/4/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.imgur.com/q4xr50n.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Allen</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">66</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/CHI-KEKE"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/CHI-KEKE" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:chilly37647@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">世界總會有那些溫暖的小角落們等待發現</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/09/20/Exception-%E6%B7%B1%E5%A4%9C%E8%A3%A1%E7%9A%84%E5%AE%88%E8%A1%9B%E9%80%B2%E9%9A%8E%E7%AF%87/" title="深夜裡的守衛進階篇"><img src="https://i.imgur.com/CxZINP1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="深夜裡的守衛進階篇"/></a><div class="content"><a class="title" href="/2025/09/20/Exception-%E6%B7%B1%E5%A4%9C%E8%A3%A1%E7%9A%84%E5%AE%88%E8%A1%9B%E9%80%B2%E9%9A%8E%E7%AF%87/" title="深夜裡的守衛進階篇">深夜裡的守衛進階篇</a><time datetime="2025-09-20T02:25:05.000Z" title="Created 2025-09-20 10:25:05">2025-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/20/Exception-%E8%AA%B0%E4%BE%86%E6%8E%A5%E4%BD%8F%E5%A4%9C%E8%A3%A1%E7%9A%84%E9%8C%AF%E8%AA%A4%EF%BC%9F/" title="誰來接住夜裡的錯誤？"><img src="https://i.imgur.com/CxZINP1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="誰來接住夜裡的錯誤？"/></a><div class="content"><a class="title" href="/2025/09/20/Exception-%E8%AA%B0%E4%BE%86%E6%8E%A5%E4%BD%8F%E5%A4%9C%E8%A3%A1%E7%9A%84%E9%8C%AF%E8%AA%A4%EF%BC%9F/" title="誰來接住夜裡的錯誤？">誰來接住夜裡的錯誤？</a><time datetime="2025-09-20T02:25:05.000Z" title="Created 2025-09-20 10:25:05">2025-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/30/Http-HttpMessageRequest/" title="HttpRequestMessage"><img src="https://i.imgur.com/hZWviQz.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HttpRequestMessage"/></a><div class="content"><a class="title" href="/2025/08/30/Http-HttpMessageRequest/" title="HttpRequestMessage">HttpRequestMessage</a><time datetime="2025-08-30T00:52:01.000Z" title="Created 2025-08-30 08:52:01">2025-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/29/Http-Refit/" title="Refit"><img src="https://i.imgur.com/hZWviQz.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Refit"/></a><div class="content"><a class="title" href="/2025/08/29/Http-Refit/" title="Refit">Refit</a><time datetime="2025-08-29T00:35:01.000Z" title="Created 2025-08-29 08:35:01">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/28/Http-HttpclientFactory/" title="HttpClientFactory"><img src="https://i.imgur.com/hZWviQz.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HttpClientFactory"/></a><div class="content"><a class="title" href="/2025/08/28/Http-HttpclientFactory/" title="HttpClientFactory">HttpClientFactory</a><time datetime="2025-08-28T00:35:01.000Z" title="Created 2025-08-28 08:35:01">2025-08-28</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>Categories</span>
            <a class="card-more-btn" href="/categories/" title="View More">
    <i class="fas fa-angle-right"></i></a>
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/SQL-%E8%81%B7%E5%A0%B4%E6%AD%B7%E9%9A%AA%E8%A8%98/"><span class="card-category-list-name">SQL 職場歷險記</span><span class="card-category-list-count">1</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E6%9C%AA%E6%9D%A5%E3%82%88%E3%82%8A%E3%81%AE%E8%BF%94%E6%AD%8C/"><span class="card-category-list-name">未来よりの返歌</span><span class="card-category-list-count">12</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E6%B3%A8%E5%85%A5%E4%B9%8B%E6%A3%AE/"><span class="card-category-list-name">注入之森</span><span class="card-category-list-count">4</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E6%B7%B1%E5%A4%9C%E5%AE%88%E8%AD%B7%E8%80%85/"><span class="card-category-list-name">深夜守護者</span><span class="card-category-list-count">9</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E7%A8%8B%E6%80%9D%E8%88%9E%E6%83%B3/"><span class="card-category-list-name">程思舞想</span><span class="card-category-list-count">13</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E7%A9%BF%E8%B6%8A%E9%9B%B2%E5%B1%A4%E7%9A%84%E4%BF%A1%E4%BD%BF/"><span class="card-category-list-name">穿越雲層的信使</span><span class="card-category-list-count">8</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E8%90%BD%E8%91%89%E4%B8%8B%E7%9A%84%E5%AD%98%E6%AA%94/"><span class="card-category-list-name">落葉下的存檔</span><span class="card-category-list-count">5</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E8%A8%AD%E8%A8%88%E5%9B%B3%E9%91%91%E7%89%A9%E8%AA%9E/"><span class="card-category-list-name">設計図鑑物語</span><span class="card-category-list-count">2</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>Tags</span></div><div class="card-tag-cloud"><a href="/tags/Design/" style="font-size: 1.23em; color: #999ea6">Design</a> <a href="/tags/Enum/" style="font-size: 1.23em; color: #999ea6">Enum</a> <a href="/tags/Delegate-x-Observer-Pattern/" style="font-size: 1.1em; color: #999">Delegate x Observer Pattern</a> <a href="/tags/Code/" style="font-size: 1.1em; color: #999">Code</a> <a href="/tags/Plugin-Pattern%EF%BC%88%E5%A4%96%E6%8E%9B%E6%A8%A1%E5%BC%8F%EF%BC%89x-Factory-Method-Pattern%EF%BC%88%E5%B7%A5%E5%BB%A0%E6%96%B9%E6%B3%95%EF%BC%89x-Strategy-Pattern%EF%BC%88%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%EF%BC%89/" style="font-size: 1.1em; color: #999">Plugin Pattern（外掛模式）x Factory Method Pattern（工廠方法）x Strategy Pattern（策略模式）</a> <a href="/tags/SQL/" style="font-size: 1.1em; color: #999">SQL</a> <a href="/tags/Delegate/" style="font-size: 1.23em; color: #999ea6">Delegate</a> <a href="/tags/EF-CORE/" style="font-size: 1.5em; color: #99a9bf">EF CORE</a> <a href="/tags/Cache/" style="font-size: 1.23em; color: #999ea6">Cache</a> <a href="/tags/Asynchronous-Programming/" style="font-size: 1.5em; color: #99a9bf">Asynchronous Programming</a> <a href="/tags/HttpClient/" style="font-size: 1.1em; color: #999">HttpClient</a> <a href="/tags/Exception-Handling/" style="font-size: 1.43em; color: #99a6b9">Exception Handling</a> <a href="/tags/JSON/" style="font-size: 1.1em; color: #999">JSON</a> <a href="/tags/LINQ/" style="font-size: 1.17em; color: #999c9f">LINQ</a> <a href="/tags/Dependency-Injection/" style="font-size: 1.3em; color: #99a1ac">Dependency Injection</a> <a href="/tags/Http/" style="font-size: 1.37em; color: #99a4b2">Http</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>Archives</span><a class="card-more-btn" href="/archives/" title="View More">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">September 2025</span><span class="card-archive-list-count">2</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">August 2025</span><span class="card-archive-list-count">8</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">July 2025</span><span class="card-archive-list-count">4</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">June 2025</span><span class="card-archive-list-count">2</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">May 2025</span><span class="card-archive-list-count">17</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">December 2024</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">November 2024</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">October 2024</span><span class="card-archive-list-count">3</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>Info</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">Article :</div><div class="item-count">66</div></div><div class="webinfo-item"><div class="item-name">Runtime :</div><div class="item-count" id="runtimeshow" data-publishDate="2024-03-01T10:00:00.000Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">UV :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">PV :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">Last Update :</div><div class="item-count" id="last-push-date" data-lastPushDate="2025-09-20T04:21:41.431Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://i.imgur.com/yZlXwed.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Allen</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">What you'll find out there is boundless freedom !</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>