<!DOCTYPE html><html lang="zh" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>平屋慢生活 - Coding也是生活的溫暖調味</title><meta name="author" content="Allen"><meta name="copyright" content="Allen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta property="og:type" content="website">
<meta property="og:title" content="平屋慢生活">
<meta property="og:url" content="https://chi-keke.github.io/">
<meta property="og:site_name" content="平屋慢生活">
<meta property="og:locale">
<meta property="og:image" content="https://i.imgur.com/q4xr50n.png">
<meta property="article:author" content="Allen">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/q4xr50n.png"><link rel="shortcut icon" href="/img/kiwibird.png"><link rel="canonical" href="https://chi-keke.github.io/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '平屋慢生活',
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2025-06-01 16:20:33'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.imgur.com/q4xr50n.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header" style="background-image: url('https://i.imgur.com/86eENHu.png')"><nav id="nav"><span id="blog-info"><a href="/" title="平屋慢生活"><span class="site-name">平屋慢生活</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">平屋慢生活</h1><div id="site_social_icons"><a class="social-icon" href="https://github.com/CHI-KEKE" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:chilly37647@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/28/NEW-EFCORE-DbUpdateException/" title="EF Core - DbUpdateException"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - DbUpdateException"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/28/NEW-EFCORE-DbUpdateException/" title="EF Core - DbUpdateException">EF Core - DbUpdateException</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-28T00:26:05.000Z" title="Created 2025-05-28 08:26:05">2025-05-28</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">你是否曾在 SaveChanges() 時迎來晴天霹靂，一行紅字 DbUpdateException 打斷了你的程式？這就像在大海航行時，突然撞上一座看不見的暗礁──平時無聲無息，一出事卻攪得你天翻地覆。
這篇文章，我們就來一起潛入這片資料海域，探查六種常見導致 DbUpdateException 的暗礁地形。每一種都有它的風險與成因，但只要理解清楚，就能順利避開，繼續駛向資料的彼岸。






💥 1. 主鍵（Primary Key）衝突，一碼歸一人主鍵（Primary Key）是資料的身份證號。若你試圖插入一筆資料，但主鍵與資料庫中已存在的資料相同，那就如同系統收到兩張一模一樣的身分證，無法分辨誰是誰，只能報錯。
12context.Users.Add(new User &#123; Id = 1 &#125;); // Id = 1 已存在context.SaveChanges(); // boom!

常見原因
手動指定主鍵值，未使用自動遞增。
測試資料未清空。




💥 2. 外鍵（Foreign Key）違反，找不到對應人外鍵（Foreign Key）是資料之間的橋 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/28/NEW-EFCORE-InvalidOperationException/" title="EF Core - InvalidOperationException"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - InvalidOperationException"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/28/NEW-EFCORE-InvalidOperationException/" title="EF Core - InvalidOperationException">EF Core - InvalidOperationException</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-28T00:26:05.000Z" title="Created 2025-05-28 08:26:05">2025-05-28</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">程式世界裡最令人頭痛的，從來不是錯誤訊息，而是「有時錯，有時對」的那種模糊不明。你是不是也曾遇過：明明昨天的程式還好好的，今天一跑卻爆了 InvalidOperationException？
這不是你寫錯，而是你不小心跨越了 DbContext 的界線。就像在海上行船，一不小心就漂出了領海，進入無人知曉的風暴。
這篇文章將帶你從根源理解 InvalidOperationException 的幾個常見場景，並透過範例與圖解，一次性釐清觀念，避免未來再被神祕的錯誤訊息追殺。




💥 DbContext 實例重複使用｜一艘船不能載兩個船長問題來源當你在多個請求或執行緒間重複使用同一個 DbContext 實例，就可能觸發 InvalidOperationException。為什麼？因為…
❗ DbContext 不是 Thread-Safe 的物件。
它內部維護著實體狀態（Added, Modified, Deleted…），而這些狀態並不是為多執行緒設計的。你讓多個線程同時操控 DbContext，就像讓兩個船長同時掌舵 —— 翻船。
12345678910public class  ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/28/NEW-EFCORE-Performance-Exist/" title="EF Core - 資料是否存在"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - 資料是否存在"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/28/NEW-EFCORE-Performance-Exist/" title="EF Core - 資料是否存在">EF Core - 資料是否存在</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-28T00:26:05.000Z" title="Created 2025-05-28 08:26:05">2025-05-28</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">




「當我們只想確認某人是否出現過，沒必要翻遍整本通訊錄。」

在資料庫的世界裡，我們經常會遇到一個簡單卻重要的問題：資料是否存在？
不論是確認某個用戶是否曾下單、某篇文章是否已發佈，這些判斷存在與否的查詢看似簡單，卻往往決定了系統的效能與延遲。尤其當資料表龐大、條件複雜時，使用錯誤的寫法可能導致嚴重的效能問題。
今天，我們就從 SQL 與 EF Core 的角度，來聊聊「資料是否存在」這件事。


🌊 SQL 寫法：COUNT vs EXISTS如果只是想知道「是否有訂單」，許多人會這樣寫
1234IF (SELECT COUNT(*) FROM Orders WHERE CustomerID = &#x27;ALFKI&#x27;) &gt; 0BEGIN    PRINT &#x27;有訂單&#x27;END

但其實效能更佳的寫法是使用 EXISTS
1234IF EXISTS (SELECT 1 FROM Orders WHERE CustomerID = &#x27;ALFKI&#x27;)BEGIN    PRINT &#x27;有訂單&#x27;END

SEL ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/27/NEW-EFCORE-Logging/" title="EF Core - Logging"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - Logging"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/27/NEW-EFCORE-Logging/" title="EF Core - Logging">EF Core - Logging</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-26T23:38:05.000Z" title="Created 2025-05-27 07:38:05">2025-05-27</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">



在平穩無波的資料操作背後，EF Core 為我們自動生成了大量 SQL 語法。這些語法就像資料的悄悄話，大部分時間默默運作，沒出錯就好。但一旦效能下滑、查詢遲緩，這些悄悄話就需要被「聽見」。
因此，我們需要打開 EF Core 的日誌紀錄機制，看看背後究竟在跑什麼樣的 SQL。
🌊 為什麼要紀錄 EF Core 自動產生的 SQL 命令?EF Core 是一套功能強大的 ORM 框架，幫助我們用物件導向的方式操作資料。但 ORM 所產生的 SQL 並非總是最有效率的選擇。
透過 Logging，我們可以：

檢查 EF Core 實際送出的 SQL 語法  
發現不必要的 JOIN 或 WHERE 條件  
優化查詢速度（例如加上索引、改用 View 或 Stored Procedure）

這對效能調教與除錯都非常有幫助。
🌊 調整 appsettings.json 的 LogLevel12345678910&#123;  &quot;Logging&quot;: &#123;    &quot;LogLevel&quot;: &#123;      &quot;Defa ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/25/NEW-EFCORE-Transaction-%E8%B7%A8/" title="EF Core - 交易的界線"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - 交易的界線"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/25/NEW-EFCORE-Transaction-%E8%B7%A8/" title="EF Core - 交易的界線">EF Core - 交易的界線</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-25T03:04:05.000Z" title="Created 2025-05-25 11:04:05">2025-05-25</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">
「啊…我有開 TransactionScopeAsyncFlowOption.Enabled 嗎？」「咦？這兩個 Context 是不是不同連線？」「等一下，我是不是跨資料庫了？那 MSDTC 呢？」
交易的邊界，就像洋流與領海，有時你以為你還在安全區，其實早已飄出防線。
這篇筆記，就是一趟從這場 Bug 航行而來的實驗紀錄 —— 我們用四種實際情境來測試 EF Core 的交易能力：

同資料庫、不同 DbContext
跨資料庫
共用連線 vs 不共用連線
TransactionScope vs BeginTransaction

如果你也曾在交易邊界迷航過，歡迎登船。



🧭 實驗開航前：DBContext 的布陣

為了這趟「交易航線實驗」，我們準備了三個 DbContext：

AdventureWorks2022：一個普通的 DbContext。
AdventureWorks2022V2：與 AdventureWorks2022 使用相同的資料庫，但是不同的 DbContext 實例。
NexCommerce_CouponContext：指向另一個資料庫。

123b ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/20/NEW-EFCORE-Scoped/" title="EF Core - DbContext 生命週期"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - DbContext 生命週期"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/20/NEW-EFCORE-Scoped/" title="EF Core - DbContext 生命週期">EF Core - DbContext 生命週期</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-20T07:28:05.000Z" title="Created 2025-05-20 15:28:05">2025-05-20</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">




「這裡的風很大，請小心 DbContext 被吹出作用域。」

開發 ASP.NET Core 應用程式時，你一定碰過這段設定
1services.AddDbContext&lt;MyDbContext&gt;();
這一行註冊你的 DbContext，但你知道它的 生命週期（Lifetime）是什麼嗎？Scoped、Transient 差在哪？又該怎麼選擇？今天我們就來一趟資料庫生命週期的航行。
🌊 EF Core 的預設生命週期：ScopedEntity Framework contexts

By default, Entity Framework contexts are added to the service container using the    scoped lifetime because web app database operations are normally scoped to the client request.

簡單來說，EF Core 的 DbContext 預設會註冊成 Scoped，也就是，每個 HTTP Request 會 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/19/NEW-EFCORE-Transaction/" title="EF Core - Transaction"><img class="post-bg" src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - Transaction"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/19/NEW-EFCORE-Transaction/" title="EF Core - Transaction">EF Core - Transaction</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-19T14:07:05.000Z" title="Created 2025-05-19 22:07:05">2025-05-19</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/">資料疆界的航圖</a></span></div><div class="content">



🐧關於 Transaction在系統開發中，最可怕的狀況不是資料存不進去，而是「資料只成功了一半」。
你可能會覺得沒什麼——多一筆少一筆資料，好像影響不大。但實際上，這種「半成品」的狀態，才是造成系統錯誤與災難的根源。

使用者下單成功了，庫存卻沒扣 → 超賣
客戶付款完成，但系統沒記帳 → 客訴、查帳風暴
發票開出來了，卻沒連到訂單 → 財報對不起來

這些問題不是 bug，也不是 crash，而是資料邏輯不一致，讓系統表面正常、實際混亂。這時候，就需要一種「全部成功或全部失敗」的保護機制 —— 這就是 交易（Transaction） 的存在價值。
交易就像你畫圖時的一顆橡皮擦：如果中間畫錯了，可以整張擦掉重來，而不是留下殘破不堪的塗鴉。
Using Transactions


🌊 SaveChanges() 自動包成 Transaction在 EF Core 中，只要你呼叫 SaveChanges() 或 SaveChangesAsync()，它就會自動包一個隱含的交易（Implicit Transaction）。這代表：
1234567using (var cont ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/15/Dependency-Injection-3/" title="Dependency Injection - 註冊、注入"><img class="post-bg" src="https://i.imgur.com/xAbpKgd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dependency Injection - 註冊、注入"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/15/Dependency-Injection-3/" title="Dependency Injection - 註冊、注入">Dependency Injection - 註冊、注入</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-15T00:07:05.000Z" title="Created 2025-05-15 08:07:05">2025-05-15</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E7%A8%8B%E6%80%9D%E8%88%9E%E6%83%B3/">程思舞想</a></span></div><div class="content">
有一天，我夢見我死了。
地獄門口，閻羅王拿出一本厚厚的註冊清單，一邊唸：「根據你的 ServiceCollection，這輩子你註冊了以下幾項依賴…」
12345678IConfidenceService          → FakeItTillYouMakeItServiceILoveService                → UnhealthyAttachmentServiceILogger&lt;YourLife&gt;           → Mom&#x27;sConstantNaggingICareerPlanner              → JustFollowWhatEveryoneElseDidServiceISelfWorthEvaluator         → DependsOnLikesAndRetweetsServiceIPurposeOfLifeResolver      → null

我試圖抗議：「等等！我沒有註冊這些啊！」閻羅王翻了翻後台的 StackTrace，淡淡地說：「人走著走著、就註冊成這樣了。」
「每一次討好別人，你就呼叫了  ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/13/Dependency-Injection-2/" title="Dependency Injection - 靜態與依賴"><img class="post-bg" src="https://i.imgur.com/xAbpKgd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dependency Injection - 靜態與依賴"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/13/Dependency-Injection-2/" title="Dependency Injection - 靜態與依賴">Dependency Injection - 靜態與依賴</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-13T14:07:05.000Z" title="Created 2025-05-13 22:07:05">2025-05-13</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E7%A8%8B%E6%80%9D%E8%88%9E%E6%83%B3/">程思舞想</a></span></div><div class="content">


今天到全聯購買了一個體重計，標籤上面寫著 static，售價 500 元。我心想：「不錯，夠便宜，看起來也夠簡單，剛好放在家門口踩一下就知道我今天有沒有胖。」回家之後，我站上去，顯示 66.6kg。
我不滿意。
我開始對著體重計自言自語：
「欸欸，我昨天吃太鹹啦，應該有水腫，不能算胖吧？」「還有，最近氣壓很低，影響感測精度你懂嗎？」「而且我最近壓力比較大可能會影響賀爾蒙，體脂肪是不是也該調整一下？」
我認真思考了一下，決定用 Dependency Injection 改造這台體重機。我開始設計以下注入內容：

IDietHistoryAnalyzer：幫我判斷昨天晚餐的影響，還會取得目前的健康最新趨勢分析
IPressureSensingService：計算壓力變動
IWeatherSensorProvider：拉取最新的氣壓與濕度資料

還打算加個 IMoodService，畢竟心情不好看起來也會比較腫，我把所有服務都準備好了，轉頭對體重機說：
「接下來，你要根據這些注入的資料來動態回傳我的理想體重。」
體重機沉默了幾秒，然後…… 它還是顯示了 66.6kg。不只沒變，它還開始 ...</div></div></div><div class="recent-post-item"><div class="post_cover left"><a href="/2025/05/11/Dependency-Injection-1/" title="Dependency Injection，不是控制，而是放手"><img class="post-bg" src="https://i.imgur.com/xAbpKgd.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Dependency Injection，不是控制，而是放手"></a></div><div class="recent-post-info"><a class="article-title" href="/2025/05/11/Dependency-Injection-1/" title="Dependency Injection，不是控制，而是放手">Dependency Injection，不是控制，而是放手</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">Created</span><time datetime="2025-05-11T04:50:05.000Z" title="Created 2025-05-11 12:50:05">2025-05-11</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E7%A8%8B%E6%80%9D%E8%88%9E%E6%83%B3/">程思舞想</a></span></div><div class="content">
森林的深處，有一間小木屋。每當霧氣升起，樹葉發出細碎的聲響，動物們會緩緩走進這裡 —— 這裡不熱鬧，卻總是剛剛好。
一隻老貓躺在椅上，望著壁爐裡跳動的火光，輕輕說：「我們啊，無法事事都靠自己。」這裡的每一份溫暖，都不是自己製造的，而是來自彼此的信任與協作。柴火是兔子帶來的，窗簾是松鼠縫的，茶是隔壁小鹿泡的。屋子本身沒有準備這一切 —— 但正因為如此，它才如此輕盈。
我們不在類別中自行建構一切，也不強求自己了解每個細節。我們只需要設計出一個能被好好照顧的容器，然後放手交給外界來注入所需的一切。



🪵 怎麼理解 DI你都怎麼叫同事？
👨‍💻 RD：欸 PO📊 PO：怎樣 RD？
看起來好像有點冷淡，對吧？彼此之間只用職稱互稱，完全不知道對方是誰、是高是矮、是圓的扁的。但這其實就蘊含了 Dependency Injection 的精髓：

他們之間的互動，是依賴「抽象（角色）」，而不是「具體（人名）」

PO 並不在乎對面的 RD 是哪個腦殘，他只關心有能當 RD 的人，誰來都行，只要符合這個職責就好。這就是所謂的依賴抽象（依賴介面），而不是綁定具體對象。



🪵 李氏替換 ...</div></div></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/#content-inner">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/#content-inner">4</a><a class="extend next" rel="next" href="/page/2/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.imgur.com/q4xr50n.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Allen</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">35</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/CHI-KEKE"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/CHI-KEKE" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:chilly37647@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">世界總會有那些溫暖的小角落們等待發現</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/05/28/NEW-EFCORE-DbUpdateException/" title="EF Core - DbUpdateException"><img src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - DbUpdateException"/></a><div class="content"><a class="title" href="/2025/05/28/NEW-EFCORE-DbUpdateException/" title="EF Core - DbUpdateException">EF Core - DbUpdateException</a><time datetime="2025-05-28T00:26:05.000Z" title="Created 2025-05-28 08:26:05">2025-05-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/28/NEW-EFCORE-InvalidOperationException/" title="EF Core - InvalidOperationException"><img src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - InvalidOperationException"/></a><div class="content"><a class="title" href="/2025/05/28/NEW-EFCORE-InvalidOperationException/" title="EF Core - InvalidOperationException">EF Core - InvalidOperationException</a><time datetime="2025-05-28T00:26:05.000Z" title="Created 2025-05-28 08:26:05">2025-05-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/28/NEW-EFCORE-Performance-Exist/" title="EF Core - 資料是否存在"><img src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - 資料是否存在"/></a><div class="content"><a class="title" href="/2025/05/28/NEW-EFCORE-Performance-Exist/" title="EF Core - 資料是否存在">EF Core - 資料是否存在</a><time datetime="2025-05-28T00:26:05.000Z" title="Created 2025-05-28 08:26:05">2025-05-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/27/NEW-EFCORE-Logging/" title="EF Core - Logging"><img src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - Logging"/></a><div class="content"><a class="title" href="/2025/05/27/NEW-EFCORE-Logging/" title="EF Core - Logging">EF Core - Logging</a><time datetime="2025-05-26T23:38:05.000Z" title="Created 2025-05-27 07:38:05">2025-05-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/25/NEW-EFCORE-Transaction-%E8%B7%A8/" title="EF Core - 交易的界線"><img src="https://github.com/CHI-KEKE/pics/blob/main/EF/ocean.png?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="EF Core - 交易的界線"/></a><div class="content"><a class="title" href="/2025/05/25/NEW-EFCORE-Transaction-%E8%B7%A8/" title="EF Core - 交易的界線">EF Core - 交易的界線</a><time datetime="2025-05-25T03:04:05.000Z" title="Created 2025-05-25 11:04:05">2025-05-25</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>Categories</span>
            
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/SQL-%E8%81%B7%E5%A0%B4%E6%AD%B7%E9%9A%AA%E8%A8%98/"><span class="card-category-list-name">SQL 職場歷險記</span><span class="card-category-list-count">1</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E6%B7%B1%E5%A4%9C%E5%AE%88%E8%AD%B7%E8%80%85/"><span class="card-category-list-name">深夜守護者</span><span class="card-category-list-count">6</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E7%A8%8B%E6%80%9D%E8%88%9E%E6%83%B3/"><span class="card-category-list-name">程思舞想</span><span class="card-category-list-count">21</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/%E8%B3%87%E6%96%99%E7%96%86%E7%95%8C%E7%9A%84%E8%88%AA%E5%9C%96/"><span class="card-category-list-name">資料疆界的航圖</span><span class="card-category-list-count">7</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>Tags</span></div><div class="card-tag-cloud"><a href="/tags/Enum/" style="font-size: 1.3em; color: #99a1ac">Enum</a> <a href="/tags/Delegate/" style="font-size: 1.3em; color: #99a1ac">Delegate</a> <a href="/tags/Dependency-Injection/" style="font-size: 1.3em; color: #99a1ac">Dependency Injection</a> <a href="/tags/Http/" style="font-size: 1.2em; color: #999da3">Http</a> <a href="/tags/JSON/" style="font-size: 1.1em; color: #999">JSON</a> <a href="/tags/HttpClient/" style="font-size: 1.1em; color: #999">HttpClient</a> <a href="/tags/EF-CORE/" style="font-size: 1.5em; color: #99a9bf">EF CORE</a> <a href="/tags/Cache/" style="font-size: 1.3em; color: #99a1ac">Cache</a> <a href="/tags/Exception-Handling/" style="font-size: 1.4em; color: #99a5b6">Exception Handling</a> <a href="/tags/Design/" style="font-size: 1.3em; color: #99a1ac">Design</a> <a href="/tags/SQL/" style="font-size: 1.1em; color: #999">SQL</a> <a href="/tags/LINQ/" style="font-size: 1.2em; color: #999da3">LINQ</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>Archives</span><a class="card-more-btn" href="/archives/" title="View More">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">May 2025</span><span class="card-archive-list-count">12</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">December 2024</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">November 2024</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">October 2024</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">August 2024</span><span class="card-archive-list-count">2</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">July 2024</span><span class="card-archive-list-count">5</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">June 2024</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">May 2024</span><span class="card-archive-list-count">4</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>Info</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">Article :</div><div class="item-count">35</div></div><div class="webinfo-item"><div class="item-name">Runtime :</div><div class="item-count" id="runtimeshow" data-publishDate="2024-03-01T10:00:00.000Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">UV :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">PV :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">Last Update :</div><div class="item-count" id="last-push-date" data-lastPushDate="2025-06-01T08:20:33.576Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://i.imgur.com/yZlXwed.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025 By Allen</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">What you'll find out there is boundless freedom !</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>